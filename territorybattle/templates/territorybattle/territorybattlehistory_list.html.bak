{% extends "swgoh/base.html" %}

{% block title %}Territory Battles{% endblock %}

{% block content %}

	<script>

		function get_selected_value(select_id, result) {
			select = document.getElementById(select_id);
			if (select) {
				select_value = select.options[select.selectedIndex].value;
				result[select_id] = select_value;
			}
		}

		function get_base_url() {
			url = window.location.href;
			tokens = url.split('?');
			return tokens[0];
		}

		function refresh() {

			query = {};

			get_selected_value('timezone', query);
			get_selected_value('tb',       query);
			get_selected_value('activity', query);
			get_selected_value('phase',    query);

			tokens = []
			for (key in query) {
				tokens.push(key + '=' + query[key]);
			}

			redirect_params = tokens.join('&');
			base_url = get_base_url();
			window.location = base_url + '?' + redirect_params;
		}

	</script>

	<div id="content-wrapper" class="d-flex flex-column">
		<div id="content">
			<div id="container-fluid">
				<h2>Territory Battle History</h2>
				<div id="filters" class="card shadow mb-4">
					<div>
						<label for="timezone">Choose a Timezone:</label>
						<select id="timezone" onchange="refresh()">{% for tz_id, tz_name in timezones.items %}
							<option value="{{ tz_id }}"{% if tz_id == timezone %} selected{% endif %}>{{ tz_name }}</option>{% endfor %}
						</select>
					</div>
					<div>
						<label for="tb">Choose a Territory Battle:</label>
						<select id="tb" onchange="refresh()">{% for tb_id, tb_name in tbs.items %}
							<option value="{{ tb_id }}"{%if tb_id == tb %} selected{% endif %}>{{ tb_name }}</option>{% endfor %}
						</select>
					</div>
					<div>
						<label for="phase">Choose a Phase:</label>
						<select id="phase" onchange="refresh()">{% for phase_id, phase_name in phases.items %}
							<option value="{{ phase_id }}"{% if phase_id == phase %} selected{% endif %}>{{ phase_name }}</option>{% endfor %}
						</select>
					</div>
					<div>
						<label for="activity">Choose some Activity:</label>
						<select id="activity" onchange="refresh()">{% for activity_id, activity_name in activities.items %}
							<option value="{{ activity_id }}"{% if activity_id == activity %} selected{% endif %}>{{ activity_name }}</option>{% endfor %}
						</select>
					</div>
				</div>
				<hr>
				<div class="card shadow mb-4">
					Found {{ events|length }} events
					<table id="dataTable" class="table table-bordered dataTable" width="100%" cellspacing="0" role="grid" aria-describedby="dataTable_info" style="width: 100%;">
						<thead>
							<tr>
								<th class="sorting" tabindex="0" aria-controls="dataTable" rowspan="1" colspan="1">Timestamp</th>
								<th class="sorting" tabindex="0" aria-controls="dataTable" rowspan="1" colspan="1">Phase</th>
								<th class="sorting" tabindex="0" aria-controls="dataTable" rowspan="1" colspan="1">Conflict</th>
								<th class="sorting" tabindex="0" aria-controls="dataTable" rowspan="1" colspan="1">Activity Type</th>
								<th class="sorting" tabindex="0" aria-controls="dataTable" rowspan="1" colspan="1">Player</th>
								<th class="sorting" tabindex="0" aria-controls="dataTable" rowspan="1" colspan="1">Score</th>
								<th class="sorting" tabindex="0" aria-controls="dataTable" rowspan="1" colspan="1">Guild Score</th>
							</tr>
						</thead>
						<tbody>{% for event in events %}
							<tr role="row">
								<td>{{ event.timestamp }}</td>
								<td>Phase {{ event.phase }}</td>
								<td>Conflict {{ event.territory }}</td>
								<td>{{ event.event_type }}</td>
								<td>{{ event.player_name}}</td>
								<td>{{ event.score }}</td>
								<td>{{ event.total }}</td>
							</tr>{% endfor %}
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>

{% endblock %}
